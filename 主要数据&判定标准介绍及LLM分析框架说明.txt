================================================================================
                主要数据 & 判定标准介绍 及 LLM分析框架说明
                    Finance Middleware v3 技术文档
================================================================================

【文档版本】v1.0
【更新日期】2025年12月17日
【适用系统】main_v3.py 金融数据分析中间件

================================================================================
                              目 录
================================================================================

一、概述
   1.1 系统架构简介
   1.2 四大模块关系图
   1.3 数据流与分析链路

二、数据模块详解
   2.1 Fundamentals（宏观基本面）模块
   2.2 Liquidity（流动性）模块
   2.3 Sentiment（市场情绪）模块
   2.4 Technicals（技术面）模块

三、判定标准与启发式标签
   3.1 各模块Regime判定逻辑
   3.2 阈值设定依据
   3.3 标签体系说明

四、LLM分析框架
   4.1 全局系统提示词（GLOBAL_SYSTEM_PROMPT）
   4.2 模块分析提示词（build_module_user_prompt）
   4.3 综合分析提示词（build_overall_user_prompt）
   4.4 对话提示词（build_chat_system_prompt）

五、跨资产传导逻辑
   5.1 利率-美元-黄金传导链
   5.2 流动性-权益/信用/加密传导链
   5.3 风险偏好-资产轮动传导链

六、权威数据来源说明

七、附录：代码结构索引

================================================================================
                        一、概 述
================================================================================

1.1 系统架构简介
--------------------------------------------------------------------------------

本系统是一个专业的金融市场数据分析中间件，旨在为买方机构（Buy-Side）的
宏观策略分析师和跨资产投资组合经理提供决策支持。系统整合了四大核心分析
维度，通过数据采集、启发式判断和LLM深度分析三层架构，生成可交易的市场
洞察。

【核心目标】
- 提供当日市场环境（Regime）判断
- 构建跨资产传导逻辑图谱
- 在不完整数据下完成"最低可用"分析闭环
- 清晰标注不确定性来源

【技术栈】
- 数据源：FRED（美联储经济数据）、Yahoo Finance、CNN Fear&Greed、
         CBOE、TradingEconomics、Google News RSS
- LLM引擎：Google Gemini API（支持thinking模式）
- 框架：FastAPI + Python 3.x


1.2 四大模块关系图
--------------------------------------------------------------------------------

                    ┌─────────────────────────────────────┐
                    │          市场快照（Snapshot）         │
                    └─────────────────────────────────────┘
                                      │
                ┌───────────────┬───────────┼───────────┬
                ▼               ▼           ▼           ▼               
            ┌──────────┐    ┌──────────┐ ┌──────────┐ ┌──────────┐
            │Fundamentals│   │Liquidity │ │Sentiment│ │Technicals│
            │ (宏观)    │   │ (流动性) │ │ (情绪)    │ │ (技术面)  │
            └──────────┘    └──────────┘ └──────────┘ └──────────┘
                │               │           │           │
                ▼               ▼           ▼           ▼
            ┌──────────┐    ┌──────────┐ ┌──────────┐ ┌──────────┐
            │macro     │    │liquidity_│ │sentiment │ │technical_│
            │_regime   │    │regime    │ │regime    │ │regime    │
            └──────────┘    └──────────┘ └──────────┘ └──────────┘
                │               │           │           │
                └───────────────┴───────────┼───────────┴
                                      ▼
                    ┌─────────────────────────────────────┐
                    │         LLM综合分析引擎              │
                    │  ┌─────────┐  ┌─────────────────┐   │
                    │  │模块短评  │  │ 综合专业版分析   │   │
                    │  │(按钮1)  │  │   (按钮2)        │   │
                    │  └─────────┘  └─────────────────┘   │
                    └─────────────────────────────────────┘


1.3 数据流与分析链路
--------------------------------------------------------------------------------

【数据采集层】
    外部API → 原始数据 → 数据清洗 → 标准化存储

【信号计算层】
    原始数据 → 衍生指标计算 → 信号（Signals）列表

【启发式判断层】
    信号 → 阈值比较 → Regime标签（Heuristic Labels）

【LLM分析层】
    信号 + 标签 + 数据质量信息 → Prompt构建 → Gemini API → 分析报告


================================================================================
                    二、数据模块详解
================================================================================

2.1 Fundamentals（宏观基本面）模块
================================================================================

【模块职责】
评估宏观经济政策环境、利率周期、美元强弱及关键经济事件，判断当前
政策立场是偏鸽派（Dovish）还是偏鹰派（Hawkish）。

【数据源】
- FRED API（美联储圣路易斯分行经济数据库）
- Yahoo Finance（DXY美元指数）
- TradingEconomics（经济日历）
- Google News RSS（财经新闻）

────────────────────────────────────────────────────────────────────────────────
数据字段详解
────────────────────────────────────────────────────────────────────────────────

┌─────────────────┬─────────────────────────────────────────────────────────────┐
│ 字段名          │ 说明                                                         │
├─────────────────┼─────────────────────────────────────────────────────────────┤
│ dgs2            │ 2年期美国国债收益率（DGS2）                                   │
├─────────────────┼─────────────────────────────────────────────────────────────┤
│ dgs10           │ 10年期美国国债收益率（DGS10）                                 │
├─────────────────┼─────────────────────────────────────────────────────────────┤
│ term_spread     │ 期限利差 = DGS10 - DGS2                                      │
├─────────────────┼─────────────────────────────────────────────────────────────┤
│ fedfunds        │ 联邦基金有效利率（EFFR）或联邦基金利率（FEDFUNDS）              │
├─────────────────┼─────────────────────────────────────────────────────────────┤
│ ffr_minus_2y    │ 政策利率相对市场利率偏离 = FedFunds - DGS2                    │
├─────────────────┼─────────────────────────────────────────────────────────────┤
│ dxy             │ 美元指数（DX-Y.NYB / DXY / USDOLLAR）                        │
├─────────────────┼─────────────────────────────────────────────────────────────┤
│ events          │ 经济日历事件（来自TradingEconomics或FRED releases）           │
├─────────────────┼─────────────────────────────────────────────────────────────┤
│ news            │ 近3天财经新闻（关键词：Federal Reserve, CPI, inflation）      │
└─────────────────┴─────────────────────────────────────────────────────────────┘

────────────────────────────────────────────────────────────────────────────────
核心指标深度解读
────────────────────────────────────────────────────────────────────────────────

【1】DGS2 / DGS10 - 美国国债收益率
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义与来源
  - DGS2: 2-Year Treasury Constant Maturity Rate
  - DGS10: 10-Year Treasury Constant Maturity Rate
  - 数据源: 美联储圣路易斯分行FRED数据库
  - 更新频率: 每日（工作日）

■ 金融学意义
  2年期收益率主要反映：
  - 市场对未来1-2年美联储利率政策的预期
  - 短期通胀预期
  - 货币政策传导的前端

  10年期收益率主要反映：
  - 长期经济增长预期
  - 长期通胀预期
  - 期限溢价（Term Premium）

■ 权威来源说明
  根据美联储（Federal Reserve）和圣路易斯联储（FRED）的定义，恒定到期
  收益率是根据每日收益率曲线通过三次样条插值计算得出的理论收益率。
  参考: https://fred.stlouisfed.org/series/DGS2

■ 判断逻辑
  - DGS2上升 → 市场预期美联储将维持较高利率或进一步加息
  - DGS2下降 → 市场预期美联储将降息
  - DGS10上升 → 经济增长预期改善 或 通胀预期上升
  - DGS10下降 → 经济放缓预期 或 避险情绪

■ 对模块的贡献度: ★★★★★（核心指标）

────────────────────────────────────────────────────────────────────────────────

【2】Term Spread（期限利差）= DGS10 - DGS2
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  10年期与2年期美国国债收益率之差，是最受关注的收益率曲线形态指标。

■ 金融学意义
  - 正常曲线（Term Spread > 0）：长期利率高于短期利率，反映经济扩张预期
  - 平坦曲线（Term Spread ≈ 0）：经济周期转折点信号
  - 倒挂曲线（Term Spread < 0）：经济衰退预警信号

■ 权威来源说明
  根据纽约联储（NY Fed）的研究，10Y-2Y收益率曲线倒挂是预测经济衰退最
  可靠的领先指标之一。自1960年代以来，每次美国经济衰退前均出现过收益
  率曲线倒挂，平均领先衰退6-18个月。
  参考: https://www.newyorkfed.org/research/capital_markets/ycfaq

■ 阈值设定依据
  - term_spread < -0.5%: 深度倒挂 → 鹰派紧缩周期
  - term_spread > 0.0%: 正常/陡峭曲线 → 鸽派/宽松预期
  - -0.5% ≤ term_spread ≤ 0.0%: 中性区间

■ 对模块的贡献度: ★★★★★（核心判定指标，决定macro_regime）

────────────────────────────────────────────────────────────────────────────────

【3】Fed Funds Rate（联邦基金利率）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  美国银行间隔夜拆借的利率，是美联储货币政策的核心工具。
  - EFFR: Effective Federal Funds Rate（实际交易加权平均利率）
  - FEDFUNDS: 月度平均联邦基金利率

■ 金融学意义
  - 美联储通过公开市场操作调节联邦基金利率来实施货币政策
  - 联邦基金利率是整个金融体系的基准利率
  - 影响银行存贷款利率、债券收益率、股票估值等

■ 权威来源说明
  联邦基金利率由美联储公开市场委员会（FOMC）在每次会议上决定目标区间。
  参考: https://www.federalreserve.gov/monetarypolicy/openmarket.htm

■ 判断逻辑
  - FFR上升 → 货币政策收紧 → 风险资产承压
  - FFR下降 → 货币政策宽松 → 风险资产受益

■ 对模块的贡献度: ★★★★☆（重要参考指标）

────────────────────────────────────────────────────────────────────────────────

【4】FFR_minus_2Y（政策利率-市场利率偏离）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  联邦基金利率与2年期国债收益率的差值。

■ 金融学意义
  - FFR - 2Y > 0: 政策利率高于市场预期的均衡利率，暗示市场预期降息
  - FFR - 2Y < 0: 政策利率低于市场预期，暗示市场预期加息
  - FFR - 2Y ≈ 0: 政策利率与市场预期一致

■ 判断逻辑
  该指标反映了市场对美联储政策路径的定价。正值越大，说明市场越预期
  美联储将转向宽松。

■ 对模块的贡献度: ★★★☆☆（交叉验证指标）

────────────────────────────────────────────────────────────────────────────────

【5】DXY（美元指数）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  美元相对于一篮子6种主要货币的加权几何平均指数。
  构成: 欧元(57.6%), 日元(13.6%), 英镑(11.9%), 加元(9.1%), 
       瑞典克朗(4.2%), 瑞士法郎(3.6%)

■ 金融学意义
  - DXY上升 → 美元走强 → 
    * 黄金承压（美元计价商品）
    * 新兴市场资产承压（美元债务成本上升）
    * 美国出口竞争力下降
    * 大宗商品价格承压

  - DXY下降 → 美元走弱 →
    * 黄金受益
    * 新兴市场资产受益
    * 大宗商品受益

■ 权威来源说明
  DXY由ICE Futures U.S.交易所计算和发布。
  参考: https://www.ice.com/publicdocs/futures_us/ICE_Dollar_Index.pdf

■ 对模块的贡献度: ★★★★☆（跨资产传导核心指标）

────────────────────────────────────────────────────────────────────────────────

【6】Economic Events（经济日历事件）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  即将发布或已发布的重要经济数据和央行事件。

■ 数据来源优先级
  1. TradingEconomics API（首选）
  2. FRED Release Dates（备选）

■ 关注的关键事件
  - CPI（消费者物价指数）- 通胀指标
  - Employment Situation（非农就业报告）- 就业市场
  - Retail Sales（零售销售）- 消费需求
  - GDP（国内生产总值）- 经济增长

■ 对模块的贡献度: ★★★☆☆（事件驱动分析辅助）

────────────────────────────────────────────────────────────────────────────────

【7】News（财经新闻）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  通过Google News RSS订阅获取的近3天财经新闻。

■ 搜索关键词
  "Federal Reserve OR CPI OR inflation"

■ 用途
  - 提供定性信息补充
  - 帮助理解市场对经济数据的反应
  - 捕捉政策信号和市场预期变化

■ 对模块的贡献度: ★★☆☆☆（定性参考）

================================================================================

2.2 Liquidity（流动性）模块
================================================================================

【模块职责】
评估美国金融系统的流动性状况，判断当前流动性环境是扩张（Easing）、
紧缩（Tightening）还是中性（Neutral）。

【数据源】
- FRED API（美联储资产负债表、RRP、TGA数据）
- Yahoo Finance（HYG、IEI ETF价格）

────────────────────────────────────────────────────────────────────────────────
数据字段详解
────────────────────────────────────────────────────────────────────────────────

┌─────────────────┬─────────────────────────────────────────────────────────────┐
│ 字段名          │ 说明                                                         │
├─────────────────┼─────────────────────────────────────────────────────────────┤
│ walcl           │ 美联储资产负债表总资产（单位：十亿美元）                        │
├─────────────────┼─────────────────────────────────────────────────────────────┤
│ rrp             │ 隔夜逆回购（Reverse Repo，单位：十亿美元）                     │
├─────────────────┼─────────────────────────────────────────────────────────────┤
│ tga             │ 财政部一般账户余额（Treasury General Account，十亿美元）       │
├─────────────────┼─────────────────────────────────────────────────────────────┤
│ net_liquidity   │ 净流动性 = WALCL - RRP - TGA                                 │
├─────────────────┼─────────────────────────────────────────────────────────────┤
│ net_change_4w   │ 过去4周净流动性变化量                                         │
├─────────────────┼─────────────────────────────────────────────────────────────┤
│ credit_ratio    │ 信用比率 = HYG / IEI                                         │
├─────────────────┼─────────────────────────────────────────────────────────────┤
│credit_change_20d│ 过去20天信用比率变化                                          │
└─────────────────┴─────────────────────────────────────────────────────────────┘

────────────────────────────────────────────────────────────────────────────────
核心指标深度解读
────────────────────────────────────────────────────────────────────────────────

【1】WALCL - 美联储资产负债表
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  美联储资产负债表总资产规模（FRED代码: WALCL - Total Assets of 
  Federal Reserve Banks）

■ 金融学意义
  - WALCL增加（扩表/QE）→ 美联储购买资产向市场注入流动性
  - WALCL减少（缩表/QT）→ 美联储出售或到期不续作资产，回收流动性

■ 权威来源说明
  数据由美联储每周三发布（H.4.1报告）。
  参考: https://www.federalreserve.gov/releases/h41/

■ 历史背景
  - 2008年金融危机前: 约9000亿美元
  - 2020年COVID后峰值: 约8.9万亿美元
  - 2024年: 约7万亿美元

■ 对模块的贡献度: ★★★★★（核心组成）

────────────────────────────────────────────────────────────────────────────────

【2】RRP - 隔夜逆回购（Overnight Reverse Repo）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  美联储通过逆回购操作从货币市场基金等机构吸收的短期资金
  （FRED代码: RRPONTSYD）

■ 金融学意义
  - RRP余额高 → 大量资金"停泊"在美联储，市场实际可用流动性减少
  - RRP余额下降 → 资金从美联储流出，进入市场，流动性改善
  
  RRP是流动性的"蓄水池"：
  - 当市场收益率不具吸引力时，资金停留在RRP（安全+有收益）
  - 当市场机会出现时，资金从RRP流出寻求更高收益

■ 权威来源说明
  由纽约联储每日发布。
  参考: https://www.newyorkfed.org/markets/rrp_faq

■ 对模块的贡献度: ★★★★★（核心组成）

────────────────────────────────────────────────────────────────────────────────

【3】TGA - 财政部一般账户
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  美国财政部在美联储开设的主要运营账户余额
  （FRED代码: WTREGEN - Treasury General Account）

■ 金融学意义
  - TGA余额上升（财政部发债筹资）→ 资金从市场流入财政部，流动性减少
  - TGA余额下降（财政部支出）→ 资金从财政部流入市场，流动性增加

  TGA是财政政策与货币流动性的桥梁：
  - 债务上限危机期间，TGA被消耗至低位
  - 债务上限提高后，财政部大规模发债补充TGA，会抽走市场流动性

■ 权威来源说明
  数据来自美联储H.4.1报告及财政部每日报表。
  参考: https://fred.stlouisfed.org/series/WTREGEN

■ 对模块的贡献度: ★★★★★（核心组成）

────────────────────────────────────────────────────────────────────────────────

【4】Net Liquidity（净流动性）= WALCL - RRP - TGA
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  市场实际可用流动性的近似度量。

■ 公式解读
  净流动性 = 美联储注入的基础货币 - 停泊在RRP的资金 - 停留在TGA的资金

■ 金融学意义
  - 净流动性是衡量"真正可用于金融市场投资的资金量"的代理变量
  - 历史研究显示，净流动性变化与风险资产（尤其是股市）走势高度相关
  - 净流动性扩张期往往对应股市上涨，收缩期对应股市调整

■ 与风险资产的相关性
  多项研究表明，净流动性指标与SPX的相关性在2020年后显著增强。
  这反映了后QE时代，流动性成为资产价格的关键驱动因素。

■ 对模块的贡献度: ★★★★★（核心判定指标，决定liquidity_regime）

────────────────────────────────────────────────────────────────────────────────

【5】Net Change 4W（4周净流动性变化）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  过去28天净流动性的绝对变化量（单位：十亿美元）。

■ 阈值设定依据
  - net_change_4w > +500B: 流动性显著扩张 → Easing
  - net_change_4w < -500B: 流动性显著收缩 → Tightening
  - 介于两者之间: 中性 → Neutral

■ 判断逻辑
  4周变化量能够过滤日常波动，捕捉趋势性变化。
  500B的阈值约为净流动性总量的8-10%，代表有意义的边际变化。

■ 对模块的贡献度: ★★★★★（核心判定指标）

────────────────────────────────────────────────────────────────────────────────

【6】Credit Ratio（信用比率）= HYG / IEI
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  高收益债券ETF（HYG）与中期国债ETF（IEI）的价格比率。

■ 组成ETF说明
  - HYG: iShares iBoxx $ High Yield Corporate Bond ETF（高收益/垃圾债）
  - IEI: iShares 3-7 Year Treasury Bond ETF（中期国债）

■ 金融学意义
  - 比率上升 → 高收益债券跑赢国债 → 信用风险偏好改善 → Risk-On
  - 比率下降 → 高收益债券跑输国债 → 信用风险规避 → Risk-Off

■ 与流动性的关系
  信用利差（隐含在HYG/IEI比率中）通常与流动性状况高度相关：
  - 流动性充裕时，投资者愿意承担更多信用风险，利差收窄
  - 流动性紧张时，投资者规避信用风险，利差走阔

■ 对模块的贡献度: ★★★☆☆（交叉验证指标）

================================================================================

2.3 Sentiment（市场情绪）模块
================================================================================

【模块职责】
评估市场参与者的风险偏好和情绪状态，判断当前是Risk-On（贪婪）、
Risk-Off（恐惧）还是中性。

【数据源】
- CNN Fear & Greed Index API
- Yahoo Finance（VIX、VIX3M）
- CBOE（Put/Call Ratio）
- Yahoo Finance（风险价差ETF）

────────────────────────────────────────────────────────────────────────────────
数据字段详解
────────────────────────────────────────────────────────────────────────────────

┌──────────────────┬────────────────────────────────────────────────────────────┐
│ 字段名           │ 说明                                                       │
├──────────────────┼────────────────────────────────────────────────────────────┤
│ fgi_score        │ CNN恐惧贪婪指数（0-100）                                   │
├──────────────────┼────────────────────────────────────────────────────────────┤
│ fgi_rating       │ 指数评级（Extreme Fear / Fear / Neutral / Greed / 极度贪婪）│
├──────────────────┼────────────────────────────────────────────────────────────┤
│ vix              │ VIX波动率指数                                              │
├──────────────────┼────────────────────────────────────────────────────────────┤
│ vix3m            │ 3个月VIX期货指数                                           │
├──────────────────┼────────────────────────────────────────────────────────────┤
│ term_structure   │ VIX期限结构（contango / backwardation / flat）            │
├──────────────────┼────────────────────────────────────────────────────────────┤
│ put_call_ratio   │ CBOE权益期权Put/Call比率                                   │
├──────────────────┼────────────────────────────────────────────────────────────┤
│ put_call_ratio_5d│ Put/Call比率5日均值                                        │
├──────────────────┼────────────────────────────────────────────────────────────┤
│ put_call_ratio_20d│ Put/Call比率20日均值                                      │
├──────────────────┼────────────────────────────────────────────────────────────┤
│ spy_xlu          │ SPY-XLU日收益差（周期vs防御）                              │
├──────────────────┼────────────────────────────────────────────────────────────┤
│ hyg_ief          │ HYG-IEF日收益差（信用风险偏好）                            │
├──────────────────┼────────────────────────────────────────────────────────────┤
│ btc_gold         │ BTC-Gold日收益差（风险资产vs避险资产）                     │
├──────────────────┼────────────────────────────────────────────────────────────┤
│ nyse_advancing   │ NYSE上涨家数                                               │
├──────────────────┼────────────────────────────────────────────────────────────┤
│ nyse_declining   │ NYSE下跌家数                                               │
├──────────────────┼────────────────────────────────────────────────────────────┤
│ nasdaq_advancing │ NASDAQ上涨家数                                             │
├──────────────────┼────────────────────────────────────────────────────────────┤
│ nasdaq_declining │ NASDAQ下跌家数                                             │
├──────────────────┼────────────────────────────────────────────────────────────┤
│ nyse_new_highs   │ NYSE 52周新高家数                                          │
├──────────────────┼────────────────────────────────────────────────────────────┤
│ nyse_new_lows    │ NYSE 52周新低家数                                          │
├──────────────────┼────────────────────────────────────────────────────────────┤
│ nasdaq_new_highs │ NASDAQ 52周新高家数                                        │
├──────────────────┼────────────────────────────────────────────────────────────┤
│ nasdaq_new_lows  │ NASDAQ 52周新低家数                                        │
├──────────────────┼────────────────────────────────────────────────────────────┤
│ advance_decline  │ 综合涨跌家数比（(NYSE+NASDAQ涨家数)/(NYSE+NASDAQ跌家数)）  │
│ _ratio           │                                                            │
├──────────────────┼────────────────────────────────────────────────────────────┤
│ new_high_low     │ 综合新高新低比（(NYSE+NASDAQ新高)/(NYSE+NASDAQ新低)）      │
│ _ratio           │                                                            │
└──────────────────┴────────────────────────────────────────────────────────────┘

────────────────────────────────────────────────────────────────────────────────
核心指标深度解读
────────────────────────────────────────────────────────────────────────────────

【1】CNN Fear & Greed Index（恐惧贪婪指数）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  CNN Money发布的综合市场情绪指数，范围0-100。

■ 构成要素（7个子指标等权）
  1. Market Momentum（市场动量）- SPX vs 125日均线
  2. Stock Price Strength（股价强度）- 52周新高vs新低
  3. Stock Price Breadth（股价广度）- 上涨vs下跌成交量
  4. Put/Call Options（期权Put/Call）- CBOE比率
  5. Junk Bond Demand（垃圾债需求）- 高收益债利差
  6. Market Volatility（市场波动）- VIX水平
  7. Safe Haven Demand（避险需求）- 股票vs债券相对表现

■ 解读区间
  - 0-25: Extreme Fear（极度恐惧）→ 潜在买入机会
  - 25-45: Fear（恐惧）
  - 45-55: Neutral（中性）
  - 55-75: Greed（贪婪）
  - 75-100: Extreme Greed（极度贪婪）→ 潜在卖出信号

■ 权威来源说明
  该指数由CNN Business维护，被广泛用作逆向投资信号。
  巴菲特名言："在别人贪婪时恐惧，在别人恐惧时贪婪"正是对此指数的
  最佳应用注解。
  参考: https://www.cnn.com/markets/fear-and-greed

■ 对模块的贡献度: ★★★★★（核心情绪指标）

────────────────────────────────────────────────────────────────────────────────

【2】VIX（CBOE波动率指数）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  基于S&P 500指数期权隐含波动率计算的30天预期波动率指数，
  俗称"恐慌指数"。

■ 计算方法
  VIX通过加权近月和次月SPX期权的隐含波动率计算得出，反映市场对
  未来30天波动率的预期。

■ 解读区间
  - VIX < 15: 极度平静（可能过度自满）
  - 15 ≤ VIX < 20: 正常波动
  - 20 ≤ VIX < 30: 波动加剧
  - VIX ≥ 30: 高波动/恐慌

■ 权威来源说明
  VIX由芝加哥期权交易所（CBOE）于1993年推出。
  参考: https://www.cboe.com/tradable_products/vix/

■ 对模块的贡献度: ★★★★★（核心波动率指标）

────────────────────────────────────────────────────────────────────────────────

【3】VIX Term Structure（VIX期限结构）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  比较VIX（30天）与VIX3M（3个月）的关系。

■ 结构类型
  - Contango（正向）: VIX3M > VIX
    → 市场预期波动率会上升，但当前相对平静
    → 通常被视为"正常"状态
    
  - Backwardation（反向）: VIX > VIX3M
    → 市场当前恐慌但预期会缓和
    → 通常出现在市场急跌时
    → 强烈的Risk-Off信号

  - Flat（平坦）: VIX ≈ VIX3M

■ 金融学意义
  期限结构反向（Backwardation）是罕见但重要的市场恐慌信号。
  历史上，VIX backwardation往往对应市场底部区域。

■ 对模块的贡献度: ★★★★☆（重要结构性指标）

────────────────────────────────────────────────────────────────────────────────

【4】Put/Call Ratio（看跌/看涨期权比率）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  特定时期内看跌期权成交量与看涨期权成交量的比值。
  数据来源: CBOE官方CSV文件（equitypc.csv）

■ 解读逻辑
  - P/C > 1.0: 看跌期权交易量更大 → 市场偏悲观/对冲需求高
  - P/C < 0.7: 看涨期权交易量更大 → 市场偏乐观/投机性强
  - P/C ≈ 0.8-0.9: 正常水平

■ 作为逆向指标
  - 极高P/C（> 1.2）可能暗示过度恐慌 → 潜在反弹信号
  - 极低P/C（< 0.5）可能暗示过度乐观 → 潜在回调信号

■ 移动平均的意义
  - 5日均值: 短期情绪
  - 20日均值: 中期趋势
  比较当日值与均值有助于判断情绪是否处于极端

■ 权威来源说明
  数据由CBOE官方发布。
  参考: https://www.cboe.com/us/options/market_statistics/

■ 对模块的贡献度: ★★★★☆（重要情绪指标）

────────────────────────────────────────────────────────────────────────────────

【5】风险价差指标（Risk Spreads）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ SPY-XLU（周期vs防御价差）
  - SPY: S&P 500 ETF（大盘代表）
  - XLU: 公用事业板块ETF（防御性板块）
  - 解读: 正值 → Risk-On（周期股跑赢防御股）
         负值 → Risk-Off（防御股跑赢）

■ HYG-IEF（信用风险价差）
  - HYG: 高收益债券ETF
  - IEF: 7-10年国债ETF
  - 解读: 正值 → 投资者愿意承担信用风险
         负值 → 投资者规避信用风险

■ BTC-Gold（风险资产vs避险资产）
  - BTC: 比特币
  - Gold: 黄金期货
  - 解读: 正值 → 风险偏好强（BTC跑赢黄金）
         负值 → 避险情绪主导

■ 对模块的贡献度: ★★★☆☆（交叉验证指标）

────────────────────────────────────────────────────────────────────────────────

【6】市场广度指标（Market Breadth）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  市场广度（Market Breadth）衡量市场整体参与程度，通过统计上涨股票数量
  与下跌股票数量的关系来评估市场的健康程度。

■ 涨跌家数（Advance/Decline）
  - 每日统计NYSE和NASDAQ交易所上涨和下跌的股票数量
  - Advance/Decline Ratio (A/D Ratio) = 上涨家数 / 下跌家数
  - 解读:
    * A/D > 1.5: 强势市场，广度健康
    * A/D ≈ 1.0: 市场分化，方向不明
    * A/D < 0.67: 弱势市场，广度恶化

■ 新高新低（New High/New Low）
  - 统计过去52周创新高和新低的股票数量
  - New High/Low Ratio = 新高家数 / 新低家数
  - 解读:
    * NH/NL > 2: 强势上涨趋势
    * NH/NL < 0.5: 强势下跌趋势
    * NH/NL ≈ 1: 趋势不明确

■ 金融学意义
  市场广度是"领先指标"，当指数创新高但广度恶化（参与股票减少）时，
  往往预示趋势即将反转。这被称为"广度背离"（Breadth Divergence），
  是技术分析中重要的预警信号。

■ 数据源说明
  数据来源: Wall Street Journal Market Data
  网页抓取: https://www.wsj.com/market-data/stocks/us
  更新频率: 盘中实时更新

■ 对模块的贡献度: ★★★★☆（重要广度指标，辅助验证市场健康度）

================================================================================

2.4 Technicals（技术面）模块
================================================================================

【模块职责】
通过价格结构和技术指标评估主要资产的趋势状态、波动特征和市场广度，
判断当前市场是趋势行情（Trending）还是区间震荡（Range）。

【数据源】
- Yahoo Finance（主要指数和资产价格）

────────────────────────────────────────────────────────────────────────────────
覆盖资产列表
────────────────────────────────────────────────────────────────────────────────

┌────────┬────────────────────────────────────────────────────────────────────┐
│ 代码   │ 说明                                                               │
├────────┼────────────────────────────────────────────────────────────────────┤
│ SPX    │ S&P 500指数（^GSPC）- 美股大盘基准                                │
├────────┼────────────────────────────────────────────────────────────────────┤
│ NDX    │ 纳斯达克100指数（^NDX）- 科技股基准                               │
├────────┼────────────────────────────────────────────────────────────────────┤
│ RSP    │ 等权重S&P 500 ETF - 市场广度代理                                  │
├────────┼────────────────────────────────────────────────────────────────────┤
│ IWM    │ 罗素2000小盘股ETF - 小盘股代理                                    │
├────────┼────────────────────────────────────────────────────────────────────┤
│ XLK    │ 科技板块ETF - 成长风格代理                                        │
├────────┼────────────────────────────────────────────────────────────────────┤
│ XLP    │ 消费必需品ETF - 防御风格代理                                      │
├────────┼────────────────────────────────────────────────────────────────────┤
│ XLU    │ 公用事业ETF - 防御风格代理                                        │
├────────┼────────────────────────────────────────────────────────────────────┤
│ DXY    │ 美元指数                                                          │
├────────┼────────────────────────────────────────────────────────────────────┤
│ GOLD   │ 黄金期货（GC=F）                                                  │
├────────┼────────────────────────────────────────────────────────────────────┤
│ CRUDE  │ 原油期货（CL=F）                                                  │
├────────┼────────────────────────────────────────────────────────────────────┤
│ BTC    │ 比特币（BTC-USD）                                                 │
└────────┴────────────────────────────────────────────────────────────────────┘

────────────────────────────────────────────────────────────────────────────────
每个资产的技术指标
────────────────────────────────────────────────────────────────────────────────

┌─────────────────────┬──────────────────────────────────────────────────────────┐
│ 指标名              │ 说明                                                     │
├─────────────────────┼──────────────────────────────────────────────────────────┤
│ close               │ 最新收盘价                                               │
├─────────────────────┼──────────────────────────────────────────────────────────┤
│ distance_ma20_pct   │ 价格与20日均线的距离（百分比）                           │
├─────────────────────┼──────────────────────────────────────────────────────────┤
│ distance_ma50_pct   │ 价格与50日均线的距离（百分比）                           │
├─────────────────────┼──────────────────────────────────────────────────────────┤
│ distance_ma200_pct  │ 价格与200日均线的距离（百分比）                          │
├─────────────────────┼──────────────────────────────────────────────────────────┤
│ atr_pct             │ 14日ATR占价格的百分比（波动率度量）                      │
├─────────────────────┼──────────────────────────────────────────────────────────┤
│ boll_width          │ 布林带宽度 = 2 * 20日标准差 / 20日均线                   │
├─────────────────────┼──────────────────────────────────────────────────────────┤
│ trend_label         │ 趋势标签（uptrend / downtrend / range）                  │
└─────────────────────┴──────────────────────────────────────────────────────────┘

────────────────────────────────────────────────────────────────────────────────
SPY期权衍生指标（模块级补充）
────────────────────────────────────────────────────────────────────────────────

┌─────────────────────┬──────────────────────────────────────────────────────────┐
│ 指标名              │ 说明                                                     │
├─────────────────────┼──────────────────────────────────────────────────────────┤
│ options_pcr_volume  │ SPY期权成交量Put/Call比率                                │
├─────────────────────┼──────────────────────────────────────────────────────────┤
│ options_pcr_oi      │ SPY期权未平仓合约Put/Call比率                            │
├─────────────────────┼──────────────────────────────────────────────────────────┤
│ total_call_volume   │ SPY看涨期权总成交量                                      │
├─────────────────────┼──────────────────────────────────────────────────────────┤
│ total_put_volume    │ SPY看跌期权总成交量                                      │
├─────────────────────┼──────────────────────────────────────────────────────────┤
│ total_call_oi       │ SPY看涨期权总未平仓合约                                  │
├─────────────────────┼──────────────────────────────────────────────────────────┤
│ total_put_oi        │ SPY看跌期权总未平仓合约                                  │
├─────────────────────┼──────────────────────────────────────────────────────────┤
│ atm_iv_call         │ 平价看涨期权隐含波动率                                   │
├─────────────────────┼──────────────────────────────────────────────────────────┤
│ atm_iv_put          │ 平价看跌期权隐含波动率                                   │
├─────────────────────┼──────────────────────────────────────────────────────────┤
│ iv_skew             │ 隐含波动率偏斜（Put IV - Call IV）                       │
├─────────────────────┼──────────────────────────────────────────────────────────┤
│ near_expiry         │ 最近到期日（用于计算的期权到期日）                       │
└─────────────────────┴──────────────────────────────────────────────────────────┘

────────────────────────────────────────────────────────────────────────────────
核心指标深度解读
────────────────────────────────────────────────────────────────────────────────

【1】Moving Averages（移动平均线）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  - MA20: 20日简单移动平均（短期趋势）
  - MA50: 50日简单移动平均（中期趋势）
  - MA200: 200日简单移动平均（长期趋势/牛熊分界）

■ 金融学意义
  移动平均线是技术分析中最基础、最广泛使用的工具。

  距离均线的含义:
  - 价格 >> MA200: 强势牛市，但可能过度延伸
  - 价格 > MA50 > MA200: 健康上升趋势
  - 价格 < MA50 < MA200: 下降趋势
  - 价格 << MA200: 深度熊市，但可能超卖

■ Trend Label判定规则
  代码中的趋势判定逻辑:
  if close > ma50 > ma200:
      trend_label = "uptrend"
  elif close < ma50 < ma200:
      trend_label = "downtrend"
  else:
      trend_label = "range"

■ 对模块的贡献度: ★★★★★（核心趋势指标）

────────────────────────────────────────────────────────────────────────────────

【2】ATR%（平均真实波幅百分比）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  14日平均真实波幅（ATR）占当前价格的百分比。

■ 计算公式
  ATR = 14日的 |High - Low| 或 |High - PrevClose| 或 |Low - PrevClose| 
        的最大值的移动平均
  ATR% = ATR / Close * 100

■ 金融学意义
  - ATR%低: 市场平静，波动小
  - ATR%高: 市场活跃，波动大
  
  ATR%可用于:
  - 止损设置（如2倍ATR止损）
  - 仓位规模调整（高波动时减仓）
  - 识别波动率扩张/收缩

■ 对模块的贡献度: ★★★★☆（波动率度量）

────────────────────────────────────────────────────────────────────────────────

【3】Bollinger Band Width（布林带宽度）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  布林带上下轨距离的标准化度量。
  boll_width = 2 * 标准差(20) / MA20

■ 金融学意义
  - 布林带收窄（Squeeze）: 波动率降低，预示突破在即
  - 布林带扩张: 波动率升高，趋势行情
  
■ 阈值设定依据
  boll_width > 0.04 被视为"有意义的波动扩张"

■ 对模块的贡献度: ★★★★☆（波动率结构）

────────────────────────────────────────────────────────────────────────────────

【4】Breadth Diff（市场广度差异）= RSP - SPX 日收益
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  等权重S&P 500（RSP）与市值加权S&P 500（SPY/SPX）的日收益差。

■ 金融学意义
  - RSP > SPX: 市场广度改善，更多股票参与上涨
              中小盘/价值股跑赢大盘成长股
  - RSP < SPX: 市场广度恶化，少数大市值股主导涨幅
              典型的"头部化"行情

■ 市场广度的重要性
  健康的牛市应该有广泛的参与度。如果涨幅集中在少数股票，
  则上涨的可持续性存疑。2023-2024年的"Magnificent 7"行情
  就是典型的低广度牛市案例。

■ 对模块的贡献度: ★★★★☆（市场健康度指标）

────────────────────────────────────────────────────────────────────────────────

【5】Style Ratio（风格比率）= XLK / XLP
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  科技板块（XLK）与消费必需品板块（XLP）的价格比率。

■ 金融学意义
  - 比率上升: 成长/科技风格占优 → Risk-On
  - 比率下降: 防御/价值风格占优 → Risk-Off

■ 风格轮动意义
  该比率是观察市场风格轮动的简便工具。当投资者预期经济扩张时，
  倾向于持有高Beta的科技股；当预期衰退时，转向低Beta的防御股。

■ 对模块的贡献度: ★★★☆☆（风格轮动指标）

────────────────────────────────────────────────────────────────────────────────

【6】SPY期权衍生指标（Options Metrics）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 定义
  通过Yahoo Finance获取SPY期权链数据，计算期权市场情绪指标。
  这些指标是对CBOE Put/Call Ratio的补充和交叉验证。

■ Options PCR（期权Put/Call比率）
  - options_pcr_volume: 基于成交量计算的PCR
  - options_pcr_oi: 基于未平仓合约计算的PCR
  
  解读:
  - PCR > 1.2: 看跌期权交易活跃，市场偏空或对冲需求强
  - PCR < 0.8: 看涨期权交易活跃，市场偏多或投机性强
  - 0.8 < PCR < 1.2: 正常范围

■ IV Skew（隐含波动率偏斜）
  定义: Put ATM IV - Call ATM IV
  
  - IV_Skew > 0.05: 看跌期权IV偏高（Put_Heavy）
    → 投资者对下行风险的对冲需求强烈
    → 可能是机构保护性对冲
    
  - IV_Skew < -0.02: 看涨期权IV偏高（Call_Heavy）
    → 投资者对上行机会的投机需求强
    → 可能是散户追涨情绪
    
  - -0.02 < IV_Skew < 0.05: 平衡状态

■ 金融学意义
  期权市场被称为"聪明钱"的活动场所。期权指标可以揭示机构投资者的
  持仓意向和对冲行为，是技术分析的重要补充维度。

  特别是IV Skew（波动率微笑/偏斜）的变化，往往领先于股价变动。
  当Put IV显著高于Call IV时，可能暗示市场参与者预期下行风险增加。

■ 数据源说明
  数据来源: Yahoo Finance Options Chain
  获取方式: yfinance.Ticker("SPY").option_chain()
  计算范围: 最近2-3个到期日的期权数据

■ 对模块的贡献度: ★★★★☆（期权市场情绪补充）


================================================================================
                    三、判定标准与启发式标签
================================================================================

3.1 各模块Regime判定逻辑
--------------------------------------------------------------------------------

系统对每个模块应用启发式规则，生成初步的Regime标签。这些标签作为
LLM分析的输入，但LLM有权根据更全面的证据进行覆盖（Override）。

┌───────────────┬────────────────────────────────────────────────────────────────┐
│ 模块          │ 判定规则                                                       │
├───────────────┼────────────────────────────────────────────────────────────────┤
│ Fundamentals  │ if term_spread < -0.5:                                        │
│ (macro_regime)│     return "Hawkish"                                          │
│               │ elif term_spread > 0.0:                                       │
│               │     return "Dovish"                                           │
│               │ else:                                                         │
│               │     return "Neutral"                                          │
├───────────────┼────────────────────────────────────────────────────────────────┤
│ Liquidity     │ if net_change_4w > 500:                                       │
│ (liquidity_   │     return "Easing"                                           │
│  regime)      │ elif net_change_4w < -500:                                    │
│               │     return "Tightening"                                       │
│               │ else:                                                         │
│               │     return "Neutral"                                          │
├───────────────┼────────────────────────────────────────────────────────────────┤
│ Sentiment     │ # 主要判断: FGI + VIX                                         │
│ (sentiment_   │ if fgi_score >= 60 and vix < 20:                              │
│  regime)      │     return "Greed"                                            │
│               │ elif fgi_score <= 40 or vix > 25:                             │
│               │     return "Fear"                                             │
│               │ # 辅助判断: 市场广度（涨跌家数比、新高新低比）                 │
│               │ elif breadth_bullish >= 2:  # AD>1.5 + NH/NL>2                │
│               │     return "Greed"                                            │
│               │ elif breadth_bullish <= -2:  # AD<0.67 + NH/NL<0.5            │
│               │     return "Fear"                                             │
│               │ else:                                                         │
│               │     return "Neutral"                                          │
├───────────────┼────────────────────────────────────────────────────────────────┤
│ Technicals    │ if trend in ("uptrend", "downtrend") and boll_width > 0.04:   │
│ (technical_   │     return "Trending"                                         │
│  regime)      │ else:                                                         │
│               │     return "Range"                                            │
├───────────────┼────────────────────────────────────────────────────────────────┤
│ Options       │ # 辅助标签（补充技术面）                                      │
│ (options_     │ if options_pcr_oi > 1.2:                                      │
│  sentiment)   │     return "Bearish"                                          │
│               │ elif options_pcr_oi < 0.8:                                    │
│               │     return "Bullish"                                          │
│               │ else:                                                         │
│               │     return "Neutral"                                          │
├───────────────┼────────────────────────────────────────────────────────────────┤
│ IV Skew       │ # 辅助标签（补充技术面）                                      │
│ (iv_skew_     │ if iv_skew > 0.05:                                            │
│  signal)      │     return "Put_Heavy" (对冲需求强)                           │
│               │ elif iv_skew < -0.02:                                         │
│               │     return "Call_Heavy" (投机需求强)                          │
│               │ else:                                                         │
│               │     return "Balanced"                                         │
└───────────────┴────────────────────────────────────────────────────────────────┘


3.2 阈值设定依据
--------------------------------------------------------------------------------

【Term Spread阈值】
- -0.5%: 历史上，当10Y-2Y利差低于-50bp时，几乎总是伴随着美联储紧缩周期
         的末期或经济衰退的临近
- 0.0%: 收益率曲线的倒挂/正常分界线

【净流动性变化阈值】
- ±500B: 约为净流动性总量（~6万亿）的8%左右，代表有意义的边际变化
- 该阈值需根据市场环境动态调整

【情绪指标阈值】
- FGI 60/40: CNN的设计中，60以上为贪婪区间，40以下为恐惧区间
- VIX 20/25: 历史中位数约17-20，25以上通常代表市场不安定

【技术面阈值】
- boll_width 0.04: 约为正常波动率的1.2-1.5倍，代表有意义的波动扩张


3.3 标签体系说明
--------------------------------------------------------------------------------

┌───────────────┬────────────────────────────────────────────────────────────────┐
│ 模块          │ 候选标签                                                       │
├───────────────┼────────────────────────────────────────────────────────────────┤
│ Fundamentals  │ Hawkish（鹰派） / Neutral（中性） / Dovish（鸽派）            │
├───────────────┼────────────────────────────────────────────────────────────────┤
│ Liquidity     │ Expansionary（扩张） / Neutral（中性） / Tightening（紧缩）   │
├───────────────┼────────────────────────────────────────────────────────────────┤
│ Sentiment     │ Risk-On（贪婪） / Neutral（中性） / Risk-Off（恐惧）          │
├───────────────┼────────────────────────────────────────────────────────────────┤
│ Technicals    │ Uptrend（上升） / Range（区间） / Downtrend（下降）           │
└───────────────┴────────────────────────────────────────────────────────────────┘


================================================================================
                    四、LLM分析框架
================================================================================

本系统使用Google Gemini API（支持thinking模式）进行深度分析。
LLM分析分为三层Prompt架构:

1. GLOBAL_SYSTEM_PROMPT: 全局角色设定与硬约束
2. Module User Prompt: 单模块分析（按钮1）
3. Overall User Prompt: 综合专业分析（按钮2）
4. Chat System Prompt: 持续对话支持

================================================================================

4.1 全局系统提示词（GLOBAL_SYSTEM_PROMPT）
================================================================================

【原文】
────────────────────────────────────────────────────────────────────────────────
你是一名买方宏观与跨资产策略分析师（Multi-Asset Macro PM）。你的输出将用于
投委会/交易晨会决策支持。

硬约束（必须遵守）：
1) 严格基于输入数据推断，不得臆造未提供的事实、数值、日期、网页内容；
   若未提供/无法确认，必须明确写"缺失/无法确认"。
2) 如输入包含 supplemental（外部补充数据），仅当 supplemental 字段带有
   "来源URL + 抓取日期/数据日期"且与快照日期逻辑一致时才可使用；
   否则视为不可用并说明原因。
3) 允许你对输入中的"启发式标签(heuristic_label)"进行覆盖，但必须给出：
   scorecard 打分、覆盖理由、以及覆盖所依赖的关键证据。
4) 输出必须结构化、可复核：每个结论都要能追溯到"指标 → 推理链条 → 结论"。
5) 输出中文，要点化；避免空话与泛泛科普；避免给出"下一步必须盯的3个数据点"
   这种独立章节。如有缺失数据，用条件句表达：例如"后续关注X；
   若X上行/下行至Y，将提高/降低Z结论置信度"。

目标：
- 给出当日市场环境（regime）与跨资产传导逻辑；
- 在不完整数据下，仍完成"最低可用"的分析闭环，并清晰标注不确定性来自何处。
────────────────────────────────────────────────────────────────────────────────

【拆解分析】

■ 角色设定
  "买方宏观与跨资产策略分析师（Multi-Asset Macro PM）"
  
  设计意图：
  - 买方视角强调可执行性（vs卖方的研究视角）
  - 宏观视角确保从宏观大局出发
  - 跨资产强调关联性分析而非单一资产
  
  这种角色定位决定了输出应该是:
  - 可用于实际交易决策
  - 有明确的Risk-On/Risk-Off倾向
  - 覆盖多资产类别

■ 硬约束1: 数据边界
  "不得臆造未提供的事实、数值、日期、网页内容"
  
  设计意图：
  - 防止LLM"幻觉"问题
  - 确保分析可追溯、可验证
  - 建立可靠的决策支持体系

■ 硬约束2: Supplemental验证
  "仅当带有来源URL + 日期且逻辑一致时才可使用"
  
  设计意图：
  - 外部数据需要验证来源
  - 防止过期或不一致数据干扰分析
  - 体现审慎的数据治理理念

■ 硬约束3: Override机制
  "允许覆盖，但必须给出scorecard打分、覆盖理由、关键证据"
  
  设计意图：
  - LLM可以挑战启发式标签（因为规则过于简化）
  - 但覆盖必须透明、可追溯
  - 引入scorecard机制确保结构化推理

■ 硬约束4: 可追溯性
  "指标 → 推理链条 → 结论"
  
  设计意图：
  - 每个结论必须有证据支持
  - 便于事后复盘和改进
  - 符合投资决策的合规要求

■ 硬约束5: 输出规范
  "避免空话与泛泛科普"
  
  设计意图：
  - 专业用户不需要基础科普
  - 节省Token和阅读时间
  - 聚焦可执行洞察

■ 目标设定
  "在不完整数据下完成最低可用分析闭环"
  
  设计意图：
  - 现实中数据永远不完美
  - 但决策不能等待完美数据
  - 明确标注不确定性比放弃分析更有价值

================================================================================

4.2 模块分析提示词（build_module_user_prompt）
================================================================================

【功能定位】
按钮1「模块AI简析」使用的用户提示词模板，用于对单个模块进行深度分析。

【适用模块】
- fundamentals（宏观基本面）
- liquidity（流动性）
- sentiment（情绪）
- technicals（技术面）

【输入变量】
- module_name: 模块名称
- as_of_date: 快照日期
- signals: 信号列表（包含name、value、quality）
- heuristic_label: 启发式标签
- missing: 缺失字段列表
- supplemental: 外部补充数据（可选）

【输出结构要求】
────────────────────────────────────────────────────────────────────────────────
1) 数据可用性与关键不确定性（≤6条要点）
   - 说明哪些信号日期不一致/口径不清会影响结论
   - 若 supplemental 存在：只在"来源+日期可核对"时使用

2) 模块内部推理链条（至少2条，写成因果箭头）
   - 格式：证据（指标/方向） → 机制解释 → 对模块的含义

3) Regime 判定（必须给 scorecard）
   - 候选集合
   - Scorecard（每条：+1 / 0 / -1 / NA）
   - 计算总分
   - 最终 Regime
   - 置信度（0-100）
   - Override Check

4) 对主要风险资产的含义（条件句，2-4条）
────────────────────────────────────────────────────────────────────────────────

【各模块Scorecard锚点】

■ Fundamentals模块:
  - 期限结构（10Y-2Y、曲线形态）
  - 政策定价（FFR-2Y 或相关替代）
  - 美元（DXY）
  - 交叉验证（Real10Y / Breakeven / 信用利差 OAS 若有）

■ Liquidity模块:
  - 净流动性水平（Net Liquidity）
  - 净流动性变化（Δ4w）
  - 组成项驱动（WALCL/RRP/TGA）
  - 交叉验证（信用比率 HYG/IEI 或 OAS）

■ Sentiment模块:
  - Fear&Greed（FGI）
  - VIX 期限结构（VIX vs VIX3M / contango/backwardation）
  - Put/Call（或其均值）
  - 交叉验证（风险价差 SPY-XLU / HYG-IEF / BTC-Gold）

■ Technicals模块:
  - 趋势（MA20/50/200 距离 + trend_label）
  - 波动/结构（ATR%、boll_width）
  - 广度（RSP-SPX）
  - 交叉验证（风格比 XLK/XLP）

【设计意图分析】

1. Scorecard机制
   强制LLM对关键指标逐一打分（+1/0/-1/NA），避免模糊的定性描述。
   这种结构化评分:
   - 提高可比性（不同时间点的分析可对比）
   - 提高可追溯性（知道哪个指标导致哪个结论）
   - 便于程序化处理

2. Override机制
   允许LLM挑战简单规则生成的标签，但要求:
   - 明确说明覆盖理由
   - 指出关键证据
   - 说明需要补齐什么数据才能更确定
   
   这种设计平衡了规则的一致性和LLM的灵活性。

3. 条件句输出
   "若X上行/下行至Y，则该模块对风险资产的影响将更偏向Z"
   
   这种条件句表达:
   - 明确不确定性的来源
   - 给出可验证的触发条件
   - 为后续跟踪提供检查点

================================================================================

4.3 综合分析提示词（build_overall_user_prompt）
================================================================================

【功能定位】
按钮2「综合AI专业分析」使用的用户提示词模板，用于跨模块整合和
多资产分析。

【输入变量】
- as_of_date: 快照日期
- prompt_context_text: 构建的快照文本摘要
- labels: 四模块启发式标签
- module_reports_or_empty: 模块短评（如果已运行按钮1）
- supplemental_overall: 外部补充数据（可选）

【输出结构要求】
────────────────────────────────────────────────────────────────────────────────
1) 数据可用性与"结论可靠性边界"
   1.1 可用数据概况
   1.2 关键缺失与影响（用"影响链条"写）

2) Regime 拼图（跨模块一致性评估）
   2.1 四模块最终 regime
   2.2 一致性评分（0-100）与冲突解释

3) 跨资产传导图谱（至少3条链条）
   - A) 利率/实际利率 → 美元 → 黄金
   - B) 流动性 → 权益/信用/加密
   - C) 风险偏好/波动结构 → 资产内部轮动

4) 市场环境结论
   4.1 Base Case（1-2周）
   4.2 1-3个月主线
   4.3 Bull / Bear 场景

5) 多资产细分分析
   必须分别输出：债市、股市（分3-5个行业/风格桶）、黄金/白银、BTC
   每个资产用同一模板：
   A) 当前驱动拆解
   B) 当前偏向 + 置信度
   C) 关键条件句
   D) 风控原则

6) 结论摘要（≤10行，用于Dashboard展示）
────────────────────────────────────────────────────────────────────────────────

【设计意图分析】

1. 分层时间框架
   - 1-2周: 短期战术观点
   - 1-3个月: 中期主线
   - Bull/Bear场景: 情景分析
   
   这种分层反映了真实投资决策的时间框架需求。

2. 跨资产传导图谱
   要求至少3条传导链条，覆盖:
   - 利率→美元→黄金（货币政策传导）
   - 流动性→权益/信用/加密（流动性传导）
   - 风险偏好→轮动（情绪传导）
   
   这种设计强制LLM思考资产间的关联性，而非孤立分析。

3. 多资产细分框架
   对每个资产使用统一模板:
   - A) 驱动拆解: 宏观/流动性/技术各1条
   - B) 偏向判断: 多/空/中性/区间
   - C) 条件句: 2条关键条件
   - D) 风控原则: 2条具体原则
   
   统一模板确保分析的完整性和可比性。

4. 一致性评分
   要求给出0-100的跨模块一致性分数，并解释冲突点。
   
   这种设计:
   - 量化了不确定性
   - 识别了需要关注的矛盾信号
   - 为投资者提供了风险提示

================================================================================

4.4 对话提示词（build_chat_system_prompt）
================================================================================

【功能定位】
Chat端点使用的系统提示词，支持基于快照的持续问答。

【设计特点】

1. 上下文注入
   将快照数据和综合报告注入系统提示词，使LLM能够回答后续问题。

2. 严格数据边界
   "必须严格基于以下两类信息回答：
   1) 快照原始数据（snapshot）
   2) 已生成的综合专业报告（last_overall_report）
   不得引入外部未提供信息，不得臆造网页内容。"

3. 结论-证据对照
   "先给结论（1-2句），再给证据点（最多3条）"
   
   这种格式适合快速问答场景，先给结论再给支撑。

4. 缺失数据处理
   "若用户问到报告未覆盖且快照也没有的数据：明确说缺失，
   并用条件句说明若未来补齐该数据，判断可能如何变化"
   
   诚实承认缺失比胡编强。


================================================================================
                    五、跨资产传导逻辑
================================================================================

5.1 利率-美元-黄金传导链
--------------------------------------------------------------------------------

【传导机制】

    美联储加息预期↑ → 短端利率↑ → 美元走强↑ → 黄金承压↓
    
    美联储降息预期↑ → 短端利率↓ → 美元走弱↓ → 黄金受益↑

【关键观察点】
- Term Spread: 收益率曲线形态
- FFR-2Y: 政策利率vs市场预期的偏离
- DXY: 美元指数
- GOLD: 黄金价格

【复杂情况】
- 实际利率 vs 名义利率: 通胀预期会影响实际利率
- 避险需求: 地缘政治风险可能打破上述传导
- 美元供需: 非美央行政策也会影响美元


5.2 流动性-权益/信用/加密传导链
--------------------------------------------------------------------------------

【传导机制】

    美联储扩表 → 净流动性↑ → 风险资产受益↑
    
    美联储缩表 → 净流动性↓ → 风险资产承压↓

【敏感度排序】
    BTC >> NDX > SPX > HYG > IEI
    
    加密货币和科技股对流动性最敏感，债券相对稳定。

【关键观察点】
- Net Liquidity: 净流动性水平
- Net Change 4W: 净流动性变化趋势
- Credit Ratio (HYG/IEI): 信用利差隐含的风险偏好


5.3 风险偏好-资产轮动传导链
--------------------------------------------------------------------------------

【传导机制】

    Risk-On: 
    VIX↓ + FGI↑ → XLK/XLP↑ + RSP-SPX↑ + BTC>Gold
    
    Risk-Off:
    VIX↑ + FGI↓ → XLK/XLP↓ + RSP-SPX↓ + Gold>BTC

【轮动规律】
- 风险偏好上升: 成长→周期→小盘→加密
- 风险偏好下降: 加密→周期→成长→防御

【关键观察点】
- FGI Score: 整体情绪水平
- VIX Term Structure: 波动率结构
- Style Ratio (XLK/XLP): 成长vs防御
- Breadth Diff (RSP-SPX): 市场广度


================================================================================
                    六、权威数据来源说明
================================================================================

【美联储官方来源】
- FRED (Federal Reserve Economic Data): https://fred.stlouisfed.org/
  提供: DGS2, DGS10, WALCL, RRPONTSYD, WTREGEN, EFFR, FEDFUNDS等
  
- 纽约联储: https://www.newyorkfed.org/
  提供: 逆回购数据、收益率曲线研究

- 美联储理事会: https://www.federalreserve.gov/
  提供: H.4.1报告、FOMC会议纪要

【交易所官方来源】
- CBOE (芝加哥期权交易所): https://www.cboe.com/
  提供: VIX指数、Put/Call Ratio

- ICE Futures: https://www.ice.com/
  提供: DXY美元指数

【数据提供商】
- TradingEconomics: https://tradingeconomics.com/
  提供: 经济日历、宏观数据

- CNN Business: https://www.cnn.com/markets
  提供: Fear & Greed Index

【市场数据】
- Yahoo Finance: https://finance.yahoo.com/
  提供: 股票、ETF、期货、加密货币价格、期权链数据

- Wall Street Journal: https://www.wsj.com/market-data
  提供: 市场广度数据（涨跌家数、新高新低）

【经济日历】
- Investing.com: https://www.investing.com/economic-calendar/
  提供: 经济日历（替代TradingEconomics免费方案）

【学术/研究来源】
- 纽约联储收益率曲线研究:
  https://www.newyorkfed.org/research/capital_markets/ycfaq
  
- 美联储流动性研究:
  https://www.federalreserve.gov/publications/financial-stability-report.htm


================================================================================
                    七、附录：代码结构索引
================================================================================

【主要函数索引】

数据获取函数:
- fetch_fundamentals(date_str)  → 宏观基本面数据
- fetch_liquidity(date_str)     → 流动性数据
- fetch_sentiment(date_str)     → 情绪数据（含市场广度）
- fetch_technicals(date_str)    → 技术面数据（含期权指标）
- fetch_market_breadth()        → 市场广度数据（涨跌家数、新高新低）
- fetch_spy_options_metrics()   → SPY期权衍生指标

判定函数:
- assign_labels(modules)        → 生成启发式标签
- compute_signals(modules, labels) → 计算信号和数据质量

Prompt构建函数:
- build_module_user_prompt()    → 模块分析Prompt
- build_overall_user_prompt()   → 综合分析Prompt
- build_chat_system_prompt()    → 对话Prompt
- build_prompt_context()        → 快照文本摘要

LLM调用函数:
- call_gemini()                 → 单次LLM调用
- call_gemini_chat()            → 多轮对话LLM调用

API端点:
- POST /v3/snapshot/run         → 生成快照
- GET  /v3/snapshot/{id}        → 获取快照
- POST /v3/analysis/module      → 模块分析
- POST /v3/analysis/overall     → 综合分析
- POST /v3/chat                 → 对话

【配置环境变量】
- FRED_API_KEY: FRED API密钥
- TE_CLIENT_KEY / TE_CLIENT_SECRET: TradingEconomics凭证
- GEMINI_API_KEY / GOOGLE_API_KEY: Gemini API密钥
- GEMINI_MODEL: 默认模型名称
- GEMINI_THINKING_LEVEL: 思考级别 (low/high)
- DATA_DIR: 数据存储目录
- APP_PASSWORD: 应用访问密码


================================================================================
                            文档结束
================================================================================

【版权声明】
本文档为Finance Middleware v3系统的技术说明文档。
文档中引用的数据定义和解释参考了美联储、CBOE、CNN等权威来源。

【修订历史】
- v1.0 (2025-12-17): 初始版本，完整覆盖四大模块和LLM框架

